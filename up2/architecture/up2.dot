digraph up2 {
   
    subgraph cluster_a {
        label="Execute"

        # Registers
        regs [label="<1> +1|<R0> R0|<R1> R1|<R2> R2|<dead> ?",shape=record];

        # Mux
        reg_in_mux [label="MUX",shape=circle]
        reg_out_mux_1 [label="MUX",shape=circle]
        reg_out_mux_2 [label="MUX",shape=circle]
    
        # Alu
        alu [label="ALU",shape=trapezium] 

        # Wiring
        reg_in_mux -> regs:R0    
        reg_in_mux -> regs:R1
        reg_in_mux -> regs:R2
        reg_in_mux -> regs:dead
        
        regs:R1 -> reg_out_mux_1
        regs:R2 -> reg_out_mux_1

        regs:1 -> reg_out_mux_2
        regs:R0 -> reg_out_mux_2
        
        reg_out_mux_2 -> alu
        reg_out_mux_1 -> alu

        alu -> reg_in_mux
          
          
    }
         
    subgraph cluster_b {
        label="Register stack"  
        subgraph cluster_0 {
            label = "WIDTH = 12\nDEPTH = M";
            style=filled;
            color=lightgrey; 
            stack_mem[label="Data",shape=record] 
        }
        subgraph cluster_1 {
            label = "WIDTH = ceil(log2(M))";
            style=filled;
            color=lightgrey; 
            stack_ptr[label="Ptr",shape=record] 
            stack_ptr_plus[label="+1",shape=circle] 
            stack_ptr_minus[label="-1",shape=circle] 
            stack_ptr_mux[label="MUX",shape=diamond]    
            stack_ptr -> stack_ptr_plus -> stack_ptr_mux
            stack_ptr -> stack_ptr_minus -> stack_ptr_mux
            stack_ptr_mux -> stack_ptr
        }
        stack_ptr -> stack_mem
    }


    subgraph cluster_c {
        label="Fetch (N >= 16)"
        subgraph cluster_0 {
            label = "WIDTH = ceil(log2(N))";
            style=filled;
            color=lightgrey; 
            pc[label="PC",shape=record]
            pc_plus_one[label="+1",shape=circle]
            pc_plus[label="+",shape=circle]
            pc_update_mux[label="MUX",shape=diamond]
            pc_add_mux[label="MUX",shape=diamond] 
            pc_plus_one -> pc_add_mux -> pc_plus -> pc_update_mux -> pc 
            pc -> pc_plus 
        } 
        subgraph cluster_1 {
            label = "WIDTH = 4\nDEPTH = N";
            style=filled;
            color=lightgrey;  
            code_space[label="Code Space",shape=record]
        }
        subgraph cluster_2 {
            label = "WIDTH = 4";
            style=filled;
            color=lightgrey;  
            ir[label="IR",shape=record]
        }
        subgraph cluster_3 {
            label = "WIDTH = ceil(log2(N))";
            style=filled;
            color=lightgrey;  
            ir_trail[label="TR(shift)",shape=record] 
        }
        bigger[label="{..}",shape=circle]
        ir -> ir_trail[label="[2:0]"]
        ir -> bigger[label="[3:0]"]
        bigger -> pc_add_mux[label="N"]
        pc -> code_space[label="N"]
        code_space -> ir[label="4"]
        ir_trail -> pc_update_mux[label="N"]
    }
}

